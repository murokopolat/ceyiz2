<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğrenci Değerlendirme Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600&family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: var(--font-family, 'Inter', sans-serif);
        }

        html[data-font='inter'] { --font-family: 'Inter', sans-serif; }
        html[data-font='roboto'] { --font-family: 'Roboto', sans-serif; }
        html[data-font='lato'] { --font-family: 'Lato', sans-serif; }
        html[data-font='poppins'] { --font-family: 'Poppins', sans-serif; }
        html[data-font='playfair'] { --font-family: 'Playfair Display', serif; }
        html[data-font='montserrat'] { --font-family: 'Montserrat', sans-serif; }
        
        :root, html[data-theme='light'] {
            --color-bg-primary: #f1f5f9;
            --color-bg-secondary: #ffffff;
            --color-bg-hover: #e2e8f0;
            --color-text-primary: #1e293b;
            --color-text-secondary: #64748b;
            --color-text-title: #0f172a;
            --color-text-inverted: #ffffff;
            --color-border: #cbd5e1;
            --color-accent-primary: #2563eb;
            --color-accent-primary-hover: #1d4ed8;
            --color-accent-primary-faded: #eff6ff;
            --color-accent-secondary: #4f46e5;
            --color-accent-secondary-hover: #4338ca;
            --color-success: #16a34a;
            --color-success-hover: #15803d;
            --color-success-faded: #f0fdf4;
            --color-danger: #dc2626;
            --color-danger-hover: #b91c1c;
            --color-danger-faded: #fef2f2;
            --color-neutral: #475569;
            --color-neutral-hover: #334155;
            --color-star: #f59e0b;
        }

        html[data-theme='dark'] {
            --color-bg-primary: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-hover: #334155;
            --color-text-primary: #e2e8f0;
            --color-text-secondary: #94a3b8;
            --color-text-title: #f1f5f9;
            --color-text-inverted: #ffffff;
            --color-border: #475569;
            --color-accent-primary: #3b82f6;
            --color-accent-primary-hover: #60a5fa;
            --color-accent-primary-faded: #1e3a8a;
            --color-accent-secondary: #6366f1;
            --color-accent-secondary-hover: #818cf8;
            --color-success: #22c55e;
            --color-success-hover: #4ade80;
            --color-success-faded: #162a22;
            --color-danger: #ef4444;
            --color-danger-hover: #f87171;
            --color-danger-faded: #2e1a1d;
            --color-neutral: #64748b;
            --color-neutral-hover: #94a3b8;
            --color-star: #facc15;
        }
        
        html[data-theme='forest'] {
            --color-bg-primary: #1a2e26;
            --color-bg-secondary: #244237;
            --color-bg-hover: #305747;
            --color-text-primary: #d4e5d9;
            --color-text-secondary: #a3b9a9;
            --color-text-title: #f0fff5;
            --color-text-inverted: #ffffff;
            --color-border: #416b57;
            --color-accent-primary: #34d399;
            --color-accent-primary-hover: #6ee7b7;
            --color-accent-primary-faded: #13271f;
            --color-accent-secondary: #2dd4bf;
            --color-accent-secondary-hover: #5eead4;
            --color-success: #4ade80;
            --color-success-hover: #86efac;
            --color-success-faded: #1b302a;
            --color-danger: #f87171;
            --color-danger-hover: #fca5a5;
            --color-danger-faded: #392129;
            --color-neutral: #528c74;
            --color-neutral-hover: #65a98d;
            --color-star: #fde047;
        }

        html[data-theme='sunset'] {
            --color-bg-primary: #2c1b3e;
            --color-bg-secondary: #432a5a;
            --color-bg-hover: #5a3a78;
            --color-text-primary: #fbd8c3;
            --color-text-secondary: #e3a9c3;
            --color-text-title: #fff0e9;
            --color-text-inverted: #ffffff;
            --color-border: #6d4d86;
            --color-accent-primary: #f97316;
            --color-accent-primary-hover: #fb923c;
            --color-accent-primary-faded: #3b254d;
            --color-accent-secondary: #f43f5e;
            --color-accent-secondary-hover: #fb7185;
            --color-success: #34d399;
            --color-success-hover: #6ee7b7;
            --color-success-faded: #1d333b;
            --color-danger: #f43f5e;
            --color-danger-hover: #fb7185;
            --color-danger-faded: #3e1b30;
            --color-neutral: #c084fc;
            --color-neutral-hover: #d8b4fe;
            --color-star: #fbbf24;
        }

        .tab-active {
            border-color: var(--color-accent-primary) !important;
            background-color: var(--color-accent-primary-faded) !important;
            color: var(--color-accent-primary) !important;
        }
        .student-card.starred {
            box-shadow: 0 0 0 3px var(--color-star);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg-hover); }
        ::-webkit-scrollbar-thumb { background: var(--color-text-secondary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-text-primary); }
        .modal-content { max-height: 85vh; }
    </style>
</head>
<body class="bg-[var(--color-bg-primary)] text-[var(--color-text-primary)] transition-colors duration-300">

    <div class="container mx-auto p-3 sm:p-4 md:p-8 relative">
        <header class="text-center mb-8 flex flex-col items-center gap-3">
             <svg class="w-12 h-12 text-[var(--color-accent-secondary)]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 11.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H4.75a.75.75 0 01-.75-.75zm0-4a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H4.75a.75.75 0 01-.75-.75zm0 8a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H4.75a.75.75 0 01-.75-.75z"></path></svg>
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-[var(--color-text-title)]">Öğrenci Değerlendirme Sistemi</h1>
            <p class="text-[var(--color-text-secondary)] mt-0 sm:mt-1">Sınıflarınızı oluşturun, öğrencilerinizi yönetin.</p>
        </header>

        <!-- Ayarlar Butonları -->
        <div class="absolute top-2 right-2 sm:top-4 md:right-8 flex items-center gap-2 z-10">
            <div class="relative" id="font-selector-container">
                <button id="font-selector-btn" class="w-10 h-10 bg-[var(--color-bg-secondary)] rounded-full shadow-md flex items-center justify-center text-[var(--color-text-secondary)] hover:text-[var(--color-accent-primary)] transition" title="Yazı Tipini Değiştir">
                    <i class="fas fa-font"></i>
                </button>
                <div id="font-options" class="absolute right-0 mt-2 w-48 bg-[var(--color-bg-secondary)] rounded-lg shadow-xl p-2 z-20 hidden ring-1 ring-black/5"></div>
            </div>
            <div class="relative" id="theme-selector-container">
                <button id="theme-selector-btn" class="w-10 h-10 bg-[var(--color-bg-secondary)] rounded-full shadow-md flex items-center justify-center text-[var(--color-text-secondary)] hover:text-[var(--color-accent-primary)] transition" title="Temayı Değiştir">
                    <i class="fas fa-palette"></i>
                </button>
                <div id="theme-options" class="absolute right-0 mt-2 w-48 bg-[var(--color-bg-secondary)] rounded-lg shadow-xl p-2 z-20 hidden ring-1 ring-black/5"></div>
            </div>
        </div>

        <!-- Sınıf ve Veri Yönetimi -->
        <div class="bg-[var(--color-bg-secondary)] p-6 rounded-2xl shadow-lg mb-8 max-w-4xl mx-auto">
            <h2 class="text-xl font-semibold mb-4 text-[var(--color-text-title)] flex items-center gap-2"><i class="fas fa-university text-[var(--color-accent-secondary)]"></i>Sınıf Yönetimi</h2>
            <form id="add-class-form" class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="class-name-input" placeholder="Yeni Sınıf Adı (örn: 8-A)" class="flex-grow p-3 bg-[var(--color-bg-primary)] border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-accent-secondary)] focus:outline-none transition-all duration-300" required>
                <button type="submit" class="bg-[var(--color-accent-secondary)] text-[var(--color-text-inverted)] font-semibold py-3 px-6 rounded-lg hover:bg-[var(--color-accent-secondary-hover)] transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i>
                    <span>Sınıf Oluştur</span>
                </button>
            </form>
            <div id="class-tabs-container" class="flex flex-wrap gap-2 border-t border-[var(--color-border)] pt-4"></div>
            <div class="border-t border-[var(--color-border)] mt-4 pt-4 flex flex-col sm:flex-row gap-2 text-sm">
                <button id="export-data-btn" class="flex-1 bg-[var(--color-bg-hover)] text-[var(--color-text-primary)] font-semibold py-2 px-4 rounded-lg hover:brightness-95 transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> Verileri Dışa Aktar (Yedekle)
                </button>
                <button id="import-data-btn" class="flex-1 bg-[var(--color-bg-hover)] text-[var(--color-text-primary)] font-semibold py-2 px-4 rounded-lg hover:brightness-95 transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-upload"></i> Verileri İçe Aktar (Geri Yükle)
                </button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </div>

        <!-- Öğrenci Bölümü -->
        <div id="student-section" class="hidden">
            <div id="stats-dashboard" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 max-w-4xl mx-auto"></div>
            <div class="bg-[var(--color-bg-secondary)] p-6 rounded-2xl shadow-lg mb-8 max-w-4xl mx-auto">
                <h2 class="text-xl font-semibold mb-4 text-[var(--color-text-title)] flex items-center gap-2"><i class="fas fa-users text-[var(--color-accent-primary)]"></i>Öğrenci Yönetimi (<span id="active-class-name-form" class="font-bold"></span>)</h2>
                <form id="add-student-form" class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="student-name-input" placeholder="Öğrenci Adı ve Soyadı" class="flex-grow p-3 bg-[var(--color-bg-primary)] border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-accent-primary)] focus:outline-none transition-all duration-300" required>
                    <button type="submit" class="bg-[var(--color-accent-primary)] text-[var(--color-text-inverted)] font-semibold py-3 px-6 rounded-lg hover:bg-[var(--color-accent-primary-hover)] transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 flex items-center justify-center gap-2">
                        <i class="fas fa-user-plus"></i>
                        <span>Öğrenci Ekle</span>
                    </button>
                </form>
                <div class="border-t border-[var(--color-border)] pt-4 flex flex-col sm:flex-row gap-4 items-center">
                    <div class="relative flex-grow w-full">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-[var(--color-text-secondary)]"></i>
                        <input type="text" id="search-student-input" placeholder="Öğrenci Ara..." class="w-full p-3 pl-12 bg-[var(--color-bg-primary)] border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-accent-primary)] focus:outline-none transition-all duration-300">
                    </div>
                    <div class="relative w-full sm:w-auto">
                        <select id="sort-students-select" class="w-full appearance-none p-3 pr-10 bg-[var(--color-bg-primary)] border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-accent-primary)] focus:outline-none transition-all duration-300">
                            <option value="name-asc">İsme Göre (A-Z)</option>
                            <option value="name-desc">İsme Göre (Z-A)</option>
                            <option value="plus-desc">En Çok Artı</option>
                            <option value="minus-desc">En Çok Eksi</option>
                        </select>
                         <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-[var(--color-text-secondary)] pointer-events-none"></i>
                    </div>
                </div>
            </div>
            <div id="student-list-container">
                <div id="student-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"></div>
            </div>
        </div>
         <div id="empty-state-no-class" class="text-center py-16 px-6 bg-[var(--color-bg-secondary)] rounded-2xl shadow-xl max-w-2xl mx-auto hidden">
            <img src="https://placehold.co/128x128/E2E8F0/64748B?text=📚" alt="Kitaplar ikonu" class="mx-auto h-32 w-32 rounded-full mb-6 ring-4 ring-[var(--color-bg-hover)]">
            <h3 class="mt-4 text-2xl font-bold text-[var(--color-text-title)]">Henüz Sınıf Yok</h3>
            <p class="mt-2 text-md text-[var(--color-text-secondary)] max-w-md mx-auto">Görünüşe göre henüz bir sınıf oluşturmadınız. Başlamak için aşağıdaki butonu kullanın.</p>
            <button id="add-first-class-btn" class="mt-6 bg-[var(--color-accent-secondary)] text-[var(--color-text-inverted)] font-semibold py-3 px-8 rounded-lg hover:bg-[var(--color-accent-secondary-hover)] transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                <i class="fas fa-plus mr-2"></i>İlk Sınıfını Oluştur
            </button>
        </div>
    </div>

    <!-- Modal ve Bildirimler -->
    <div id="student-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-[var(--color-bg-secondary)] rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0 modal-content overflow-y-auto">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-[var(--color-text-title)]" id="modal-student-name"></h2>
                    <button id="close-modal-btn" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] text-2xl leading-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-[var(--color-bg-hover)] p-4 rounded-xl">
                        <h3 class="font-semibold text-lg text-[var(--color-success)] mb-3 flex items-center gap-2"><i class="fas fa-plus-circle"></i>Artıları (<span id="plus-count">0</span>)</h3>
                        <ul id="plus-list" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                        <button id="add-plus-btn" class="mt-4 w-full bg-[var(--color-success)] text-white font-semibold py-2 px-4 rounded-lg hover:bg-[var(--color-success-hover)] transition-all duration-300 flex items-center justify-center gap-2 transform hover:-translate-y-0.5">
                            <i class="fas fa-plus"></i> <span>Artı Ekle</span>
                        </button>
                    </div>
                    <div class="bg-[var(--color-bg-hover)] p-4 rounded-xl">
                        <h3 class="font-semibold text-lg text-[var(--color-danger)] mb-3 flex items-center gap-2"><i class="fas fa-minus-circle"></i>Eksileri (<span id="minus-count">0</span>)</h3>
                        <ul id="minus-list" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2"></ul>
                        <button id="add-minus-btn" class="mt-4 w-full bg-[var(--color-danger)] text-white font-semibold py-2 px-4 rounded-lg hover:bg-[var(--color-danger-hover)] transition-all duration-300 flex items-center justify-center gap-2 transform hover:-translate-y-0.5">
                            <i class="fas fa-minus"></i> <span>Eksi Ekle</span>
                        </button>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="font-semibold text-lg text-[var(--color-text-title)] mb-3 flex items-center gap-2"><i class="fas fa-sticky-note"></i>Öğrenci Hakkında Notlar</h3>
                    <textarea id="notes-textarea" class="w-full p-3 bg-[var(--color-bg-primary)] border border-[var(--color-border)] rounded-lg h-28 focus:ring-2 focus:ring-[var(--color-accent-primary)] focus:outline-none transition-all duration-300" placeholder="Bu alana öğrenciyle ilgili notlarınızı ekleyebilirsiniz..."></textarea>
                    <button id="save-notes-btn" class="mt-3 w-full bg-[var(--color-neutral)] text-[var(--color-text-inverted)] font-semibold py-2 px-4 rounded-lg hover:bg-[var(--color-neutral-hover)] transition-all duration-300 flex items-center justify-center gap-2 transform hover:-translate-y-0.5">
                        <i class="fas fa-save"></i> <span>Notları Kaydet</span>
                    </button>
                </div>
            </div>
            <div class="bg-[var(--color-bg-hover)] p-4 md:p-6 mt-4 rounded-b-2xl">
                 <button id="delete-student-btn" class="w-full bg-transparent border-2 border-[var(--color-danger)] text-[var(--color-danger)] font-semibold py-2 px-4 rounded-lg hover:bg-[var(--color-danger)] hover:text-white transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-trash-alt"></i> <span>Bu Öğrenciyi Sil</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="prompt-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden z-50 p-4">
        <div id="prompt-modal-content" class="bg-[var(--color-bg-secondary)] rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="prompt-modal-title" class="text-lg font-semibold mb-2 text-[var(--color-text-title)]"></h3>
            <p id="prompt-modal-text" class="text-[var(--color-text-secondary)] mb-4 text-sm"></p>
            <input type="text" id="prompt-modal-input" class="w-full p-2 bg-[var(--color-bg-primary)] border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-accent-primary)] focus:outline-none transition mb-4" placeholder="">
            <div class="flex justify-end gap-3">
                <button id="prompt-modal-cancel-btn" class="bg-[var(--color-bg-hover)] text-[var(--color-text-primary)] font-semibold py-2 px-4 rounded-lg hover:brightness-95 transition">İptal</button>
                <button id="prompt-modal-confirm-btn" class="text-white font-semibold py-2 px-4 rounded-lg transition"></button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-300 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getEl = (id) => document.getElementById(id);

            const addClassForm = getEl('add-class-form');
            const classNameInput = getEl('class-name-input');
            const classTabsContainer = getEl('class-tabs-container');
            const studentSection = getEl('student-section');
            const activeClassNameForm = getEl('active-class-name-form');
            const addStudentForm = getEl('add-student-form');
            const studentNameInput = getEl('student-name-input');
            const studentList = getEl('student-list');
            const searchStudentInput = getEl('search-student-input');
            const sortStudentsSelect = getEl('sort-students-select');
            const statsDashboard = getEl('stats-dashboard');
            const toast = getEl('toast');
            const emptyStateNoClass = getEl('empty-state-no-class');
            const addFirstClassBtn = getEl('add-first-class-btn');
            const exportDataBtn = getEl('export-data-btn');
            const importDataBtn = getEl('import-data-btn');
            const importFileInput = getEl('import-file-input');

            const themeSelectorContainer = getEl('theme-selector-container');
            const themeSelectorBtn = getEl('theme-selector-btn');
            const themeOptions = getEl('theme-options');
            const fontSelectorContainer = getEl('font-selector-container');
            const fontSelectorBtn = getEl('font-selector-btn');
            const fontOptions = getEl('font-options');
            
            const themes = [ { id: 'light', name: 'Varsayılan' }, { id: 'dark', name: 'Gece' }, { id: 'forest', name: 'Orman' }, { id: 'sunset', name: 'Gün Batımı' } ];
            const fonts = [ { id: 'inter', name: 'Inter' }, { id: 'roboto', name: 'Roboto' }, { id: 'lato', name: 'Lato' }, { id: 'poppins', name: 'Poppins' }, { id: 'playfair', name: 'Playfair Display' }, { id: 'montserrat', name: 'Cocogoose (Benzeri)' } ];

            const studentModal = getEl('student-modal');
            const studentModalContent = studentModal.querySelector('.modal-content');
            const closeModalBtn = getEl('close-modal-btn');
            const modalStudentName = getEl('modal-student-name');
            const plusCount = getEl('plus-count');
            const plusList = getEl('plus-list');
            const addPlusBtn = getEl('add-plus-btn');
            const minusCount = getEl('minus-count');
            const minusList = getEl('minus-list');
            const addMinusBtn = getEl('add-minus-btn');
            const notesTextarea = getEl('notes-textarea');
            const saveNotesBtn = getEl('save-notes-btn');
            const deleteStudentBtn = getEl('delete-student-btn');

            const promptModal = getEl('prompt-modal');
            const promptModalContent = promptModal.querySelector('#prompt-modal-content');
            const promptModalTitle = getEl('prompt-modal-title');
            const promptModalText = getEl('prompt-modal-text');
            const promptModalInput = getEl('prompt-modal-input');
            const promptModalCancelBtn = getEl('prompt-modal-cancel-btn');
            const promptModalConfirmBtn = getEl('prompt-modal-confirm-btn');
            let modalResolver;

            let appData = { classes: [], students: {}, activeClass: null };
            let currentStudentId = null;

            function applyTheme(themeId) { document.documentElement.setAttribute('data-theme', themeId); localStorage.setItem('appTheme', themeId); }
            function applyFont(fontId) { document.documentElement.setAttribute('data-font', fontId); localStorage.setItem('appFont', fontId); }
            function renderOptions(container, items, callback) {
                container.innerHTML = '';
                items.forEach(item => {
                    const option = document.createElement('button');
                    option.className = 'w-full text-left px-4 py-2 rounded-md text-sm text-[var(--color-text-primary)] hover:bg-[var(--color-bg-hover)]';
                    option.textContent = item.name;
                    if(item.id.includes('-')) option.style.fontFamily = `var(--font-family, ${item.name})`;
                    option.addEventListener('click', () => { callback(item.id); container.classList.add('hidden'); });
                    container.appendChild(option);
                });
            }
            function loadTheme() { applyTheme(localStorage.getItem('appTheme') || 'light'); }
            function loadFont() { applyFont(localStorage.getItem('appFont') || 'inter'); }
            
            function loadData() {
                const storedData = localStorage.getItem('studentAppData');
                if (storedData) appData = JSON.parse(storedData);
                if (!appData.activeClass || !appData.classes.includes(appData.activeClass)) {
                    appData.activeClass = appData.classes.length > 0 ? appData.classes[0] : null;
                }
                updateUI();
            }
            function saveData() { localStorage.setItem('studentAppData', JSON.stringify(appData)); }
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl transition-all duration-300 z-50 ${type === 'success' ? 'bg-[var(--color-success)]' : 'bg-[var(--color-danger)]'}`;
                toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); }, 3000);
            }

            function updateUI() {
                renderClasses();
                renderDashboard();
                renderStudents();
                const hasClasses = appData.classes.length > 0;
                studentSection.classList.toggle('hidden', !hasClasses);
                emptyStateNoClass.classList.toggle('hidden', hasClasses);
            }

            function renderClasses() {
                classTabsContainer.innerHTML = '';
                appData.classes.forEach(className => {
                    const tab = document.createElement('div');
                    tab.className = `flex items-center gap-2 border-2 rounded-full px-4 py-2 text-sm font-semibold cursor-pointer transition-all duration-300 ${className === appData.activeClass ? 'tab-active' : 'text-[var(--color-text-secondary)] border-transparent hover:bg-[var(--color-bg-hover)]'}`;
                    tab.innerHTML = `<span>${className}</span><button data-class="${className}" class="delete-class-btn text-slate-400 hover:text-[var(--color-danger)] text-xs">&times;</button>`;
                    
                    tab.addEventListener('click', (e) => { if (!e.target.classList.contains('delete-class-btn')) { appData.activeClass = className; saveData(); updateUI(); } });
                    tab.querySelector('.delete-class-btn').addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (await openPromptModal({ title: `'${className}' Sınıfını Sil`, text: `Bu sınıfı ve içindeki tüm öğrencileri kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`, confirmText: 'Evet, Sil', confirmClass: 'bg-[var(--color-danger)] hover:bg-[var(--color-danger-hover)]', showInput: false })) {
                            deleteClass(className);
                        }
                    });
                    classTabsContainer.appendChild(tab);
                });
            }

            function renderDashboard() {
                if (!appData.activeClass) { statsDashboard.innerHTML = ''; return; }
                const students = appData.students[appData.activeClass] || [];
                const totalStudents = students.length;
                const totalPluses = students.reduce((acc, s) => acc + s.pluses.length, 0);
                const totalMinuses = students.reduce((acc, s) => acc + s.minuses.length, 0);

                statsDashboard.innerHTML = `
                    <div class="bg-[var(--color-bg-secondary)] p-5 rounded-xl shadow-lg flex items-center gap-4 transition-transform hover:scale-105"><div class="w-12 h-12 flex items-center justify-center bg-gradient-to-br from-[var(--color-accent-primary)] to-[var(--color-accent-secondary)] text-white rounded-xl shadow-md"><i class="fas fa-users text-xl"></i></div><div><div class="text-sm text-[var(--color-text-secondary)]">Toplam Öğrenci</div><div class="text-2xl font-bold text-[var(--color-text-title)]">${totalStudents}</div></div></div>
                    <div class="bg-[var(--color-bg-secondary)] p-5 rounded-xl shadow-lg flex items-center gap-4 transition-transform hover:scale-105"><div class="w-12 h-12 flex items-center justify-center bg-gradient-to-br from-[var(--color-success)] to-green-400 text-white rounded-xl shadow-md"><i class="fas fa-plus-circle text-xl"></i></div><div><div class="text-sm text-[var(--color-text-secondary)]">Toplam Artı</div><div class="text-2xl font-bold text-[var(--color-text-title)]">${totalPluses}</div></div></div>
                    <div class="bg-[var(--color-bg-secondary)] p-5 rounded-xl shadow-lg flex items-center gap-4 transition-transform hover:scale-105"><div class="w-12 h-12 flex items-center justify-center bg-gradient-to-br from-[var(--color-danger)] to-red-400 text-white rounded-xl shadow-md"><i class="fas fa-minus-circle text-xl"></i></div><div><div class="text-sm text-[var(--color-text-secondary)]">Toplam Eksi</div><div class="text-2xl font-bold text-[var(--color-text-title)]">${totalMinuses}</div></div></div>
                `;
            }

            function renderStudents() {
                studentList.innerHTML = '';
                if (!appData.activeClass) return;
                
                activeClassNameForm.textContent = appData.activeClass;
                let students = appData.students[appData.activeClass] || [];

                const searchTerm = searchStudentInput.value.toLowerCase();
                if (searchTerm) {
                    students = students.filter(s => s.name.toLowerCase().includes(searchTerm));
                }
                
                const sortValue = sortStudentsSelect.value;
                students.sort((a, b) => {
                    switch (sortValue) {
                        case 'name-asc': return a.name.localeCompare(b.name);
                        case 'name-desc': return b.name.localeCompare(a.name);
                        case 'plus-desc': return b.pluses.length - a.pluses.length;
                        case 'minus-desc': return b.minuses.length - a.minuses.length;
                        default: return 0;
                    }
                });

                if (students.length === 0) {
                    studentList.innerHTML = `<div class="text-center py-16 px-6 bg-[var(--color-bg-secondary)] rounded-2xl shadow-xl col-span-full"><img src="https://placehold.co/128x128/E2E8F0/64748B?text=🧑‍🎓" alt="Öğrenci ikonu" class="mx-auto h-32 w-32 rounded-full mb-6 ring-4 ring-[var(--color-bg-hover)]"><h3 class="mt-2 text-2xl font-bold text-[var(--color-text-title)]">Öğrenci Bulunamadı</h3><p class="mt-2 text-md text-[var(--color-text-secondary)] max-w-md mx-auto">${searchStudentInput.value ? 'Arama kriterlerinizi değiştirin veya' : ''} yukarıdan yeni bir öğrenci ekleyin.</p></div>`;
                    return;
                }
                
                students.forEach(student => {
                    const studentCard = document.createElement('div');
                    studentCard.className = `student-card bg-[var(--color-bg-secondary)] rounded-2xl shadow-lg cursor-pointer hover:shadow-xl hover:-translate-y-1.5 transition-all duration-300 relative ${student.isStarred ? 'starred' : ''}`;
                    studentCard.dataset.id = student.id;
                    studentCard.innerHTML = `
                        <button class="star-btn absolute top-4 right-4 text-xl ${student.isStarred ? 'text-[var(--color-star)]' : 'text-[var(--color-text-secondary)]'} hover:text-[var(--color-star)] transition-transform duration-200 hover:scale-125"><i class="${student.isStarred ? 'fas' : 'far'} fa-star"></i></button>
                        <div class="flex flex-col items-center text-center p-6">
                            <div class="w-20 h-20 mb-4 rounded-full bg-[var(--color-accent-primary-faded)] flex items-center justify-center text-[var(--color-accent-primary)] font-bold text-3xl ring-4 ring-[var(--color-bg-hover)]">${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                            <h3 class="font-semibold text-lg text-[var(--color-text-title)]">${student.name}</h3>
                            <div class="flex gap-4 text-sm mt-2">
                                <span class="text-[var(--color-success)] font-medium"><i class="fas fa-plus-circle mr-1"></i>${student.pluses.length}</span>
                                <span class="text-[var(--color-danger)] font-medium"><i class="fas fa-minus-circle mr-1"></i>${student.minuses.length}</span>
                            </div>
                        </div>`;
                    studentCard.querySelector('.star-btn').addEventListener('click', (e) => { e.stopPropagation(); toggleStar(student.id); });
                    studentCard.addEventListener('click', () => openStudentModal(student.id));
                    studentList.appendChild(studentCard);
                });
            }
            
            function deleteClass(className) {
                delete appData.students[className];
                appData.classes = appData.classes.filter(c => c !== className);
                if (appData.activeClass === className) appData.activeClass = appData.classes.length > 0 ? appData.classes[0] : null;
                saveData(); updateUI(); showToast(`'${className}' sınıfı silindi.`, 'error');
            }

            function toggleStar(studentId) {
                const student = (appData.students[appData.activeClass] || []).find(s => s.id === studentId);
                if (student) { student.isStarred = !student.isStarred; saveData(); renderStudents(); }
            }

            function getCurrentStudent() { return (appData.students[appData.activeClass] || []).find(s => s.id === currentStudentId); }
            
            function openStudentModal(studentId) {
                currentStudentId = studentId;
                const student = getCurrentStudent();
                if (!student) return;
                modalStudentName.textContent = student.name;
                notesTextarea.value = student.notes;
                updateModalLists(student);
                studentModal.classList.remove('hidden');
                setTimeout(() => studentModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }
            
            function updateModalLists(student){
                if(!student) return;
                plusCount.textContent = student.pluses.length;
                minusCount.textContent = student.minuses.length;
                const generateList = (listEl, type) => {
                    listEl.innerHTML = '';
                    const isPlus = type === 'pluses';
                    student[type].forEach((item, index) => {
                        const date = new Date(item.date).toLocaleDateString('tr-TR');
                        const li = document.createElement('li');
                        li.className = `border-l-4 p-3 rounded-r-lg ${isPlus ? 'border-[var(--color-success)] bg-[var(--color-success-faded)]' : 'border-[var(--color-danger)] bg-[var(--color-danger-faded)]'}`;
                        li.innerHTML = `<div class="flex justify-between items-start"><p class="text-[var(--color-text-primary)] break-all mr-2">${item.reason}</p><button data-index="${index}" class="remove-${type}-btn text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] leading-none flex-shrink-0">&times;</button></div><div class="text-xs text-[var(--color-text-secondary)] mt-1"><i class="far fa-calendar-alt mr-1.5"></i>${date}</div>`;
                        listEl.appendChild(li);
                    });
                };
                generateList(plusList, 'pluses');
                generateList(minusList, 'minuses');
            }
            
            function closeStudentModal() {
                studentModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { studentModal.classList.add('hidden'); }, 300);
            }

            function openPromptModal({ title, text = '', confirmText, confirmClass, showInput = true, placeholder = '' }) {
                promptModalTitle.textContent = title;
                promptModalText.textContent = text;
                promptModalConfirmBtn.textContent = confirmText;
                promptModalConfirmBtn.className = `text-white font-semibold py-2 px-4 rounded-lg transition ${confirmClass || 'bg-[var(--color-accent-primary)] hover:bg-[var(--color-accent-primary-hover)]'}`;
                promptModalInput.style.display = showInput ? 'block' : 'none';
                promptModalInput.value = '';
                promptModalInput.placeholder = placeholder;
                promptModal.classList.remove('hidden');
                setTimeout(() => promptModalContent.classList.remove('scale-95', 'opacity-0'), 10);
                return new Promise(resolve => { modalResolver = resolve; });
            }

            function closePromptModal() {
                promptModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { promptModal.classList.add('hidden'); }, 300);
            }

            // --- Olay Dinleyicileri ---
            themeSelectorBtn.addEventListener('click', () => themeOptions.classList.toggle('hidden'));
            fontSelectorBtn.addEventListener('click', () => fontOptions.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!themeSelectorContainer.contains(e.target)) themeOptions.classList.add('hidden');
                if (!fontSelectorContainer.contains(e.target)) fontOptions.classList.add('hidden');
            });

            addClassForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newClassName = classNameInput.value.trim();
                if (newClassName && !appData.classes.includes(newClassName)) {
                    appData.classes.push(newClassName);
                    appData.students[newClassName] = [];
                    appData.activeClass = newClassName;
                    saveData(); updateUI(); classNameInput.value = ''; showToast(`'${newClassName}' sınıfı oluşturuldu!`, 'success');
                } else if (appData.classes.includes(newClassName)) {
                    showToast('Bu sınıf zaten mevcut!', 'error');
                }
            });

            addStudentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const studentName = studentNameInput.value.trim();
                if (studentName && appData.activeClass) {
                    const newStudent = { id: Date.now(), name: studentName, pluses: [], minuses: [], notes: '', isStarred: false };
                    if (!appData.students[appData.activeClass]) appData.students[appData.activeClass] = [];
                    appData.students[appData.activeClass].push(newStudent);
                    saveData(); renderStudents(); renderDashboard(); studentNameInput.value = ''; showToast(`${studentName} eklendi!`, 'success');
                }
            });
            
            addFirstClassBtn.addEventListener('click', () => {
                classNameInput.focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            searchStudentInput.addEventListener('input', renderStudents);
            sortStudentsSelect.addEventListener('change', renderStudents);
            
            closeModalBtn.addEventListener('click', closeStudentModal);
            studentModal.addEventListener('click', (e) => { if (e.target === studentModal) closeStudentModal(); });

            const addPlusMinus = async (type) => {
                const isPlus = type === 'pluses';
                const reason = await openPromptModal({ title: isPlus ? 'Artı Ekle' : 'Eksi Ekle', confirmText: 'Ekle', placeholder: `${isPlus ? 'Artı' : 'Eksi'} ekleme nedeniniz...`, confirmClass: isPlus ? '' : 'bg-[var(--color-danger)] hover:bg-[var(--color-danger-hover)]' });
                if (reason && reason.trim()) {
                    const student = getCurrentStudent();
                    if(student) {
                        student[type].push({ reason: reason.trim(), date: new Date().toISOString() });
                        saveData(); updateModalLists(student); renderStudents(); renderDashboard();
                    }
                }
            };
            addPlusBtn.addEventListener('click', () => addPlusMinus('pluses'));
            addMinusBtn.addEventListener('click', () => addPlusMinus('minuses'));

            promptModalConfirmBtn.addEventListener('click', () => {
                const isInputVisible = promptModalInput.style.display !== 'none';
                if (modalResolver) modalResolver(isInputVisible ? promptModalInput.value : true);
                closePromptModal();
            });
            promptModalCancelBtn.addEventListener('click', () => { if (modalResolver) modalResolver(null); closePromptModal(); });

            const removePlusMinus = (e, type) => {
                const btn = e.target.closest(`.remove-${type}-btn`);
                if(btn) {
                    const index = btn.dataset.index;
                    const student = getCurrentStudent();
                    student[type].splice(index, 1);
                    saveData(); updateModalLists(student); renderStudents(); renderDashboard();
                }
            };
            plusList.addEventListener('click', (e) => removePlusMinus(e, 'pluses'));
            minusList.addEventListener('click', (e) => removePlusMinus(e, 'minuses'));

            saveNotesBtn.addEventListener('click', () => {
                const student = getCurrentStudent();
                if(student) { student.notes = notesTextarea.value.trim(); saveData(); showToast('Notlar kaydedildi!', 'success'); }
            });
            
            deleteStudentBtn.addEventListener('click', async () => {
                const student = getCurrentStudent();
                if (student && await openPromptModal({ title: `'${student.name}' Silinsin mi?`, text: `Bu öğrenciyi kalıcı olarak silmek istediğinizden emin misiniz?`, confirmText: 'Evet, Sil', confirmClass: 'bg-[var(--color-danger)] hover:bg-[var(--color-danger-hover)]', showInput: false })) {
                    appData.students[appData.activeClass] = appData.students[appData.activeClass].filter(s => s.id !== currentStudentId);
                    saveData(); renderStudents(); renderDashboard(); closeStudentModal(); showToast(`${student.name} silindi.`, 'error');
                }
            });

            exportDataBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'ogrenci-degerlendirme-yedek.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showToast('Veriler dışa aktarıldı!', 'success');
            });

            importDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                try {
                    const importedData = JSON.parse(await file.text());
                    if (importedData.classes && importedData.students) {
                        if(await openPromptModal({title: 'Verileri İçe Aktar', text: 'Mevcut tüm verilerinizin üzerine yazılacaktır. Bu işlem geri alınamaz. Onaylıyor musunuz?', confirmText: 'Evet, Onaylıyorum', showInput: false})) {
                            appData = importedData;
                            appData.activeClass = appData.classes[0] || null;
                            saveData(); loadData(); showToast('Veriler başarıyla içe aktarıldı!', 'success');
                        }
                    } else { throw new Error('Geçersiz dosya formatı'); }
                } catch (error) { showToast('Veriler içe aktarılamadı. Dosya bozuk olabilir.', 'error'); }
                importFileInput.value = '';
            });

            // Başlangıç
            loadTheme();
            loadFont();
            renderOptions(themeOptions, themes, applyTheme);
            renderOptions(fontOptions, fonts, applyFont);
            loadData();
        });
    </script>
</body>
</html>

